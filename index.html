<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>정산 링크 생성기</title>
    <!-- OGP 태그 시작 (링크 미리보기용) -->
    <meta property="og:type" content="website">
    <!-- URL은 페이지 로드 시 window.location.href로 설정됩니다. -->
    <meta property="og:url" id="ogUrl" content=""> 
    <meta property="og:title" id="ogTitle" content="더치페이 정산 링크 생성 및 공유">
    <meta property="og:description" id="ogDescription" content="복잡한 정산, 이 링크 하나로 끝! 금액과 계좌 정보를 QR 코드로 간편하게 공유하세요.">
    <!-- OGP 태그 종료 -->

    <!-- Tailwind CSS CDN 로드 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Library CDN 로드 (qrcode.js 사용) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        /* Custom style for the subtle background change on copy success */
        .copy-success {
            transition: background-color 0.3s ease-in-out;
            background-color: #d1fae5 !important; /* Tailwind green-100 */
        }
        /* Style for the copy message overlay */
        .copy-message-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(209, 250, 229, 0.95); /* green-100 with opacity */
            border-radius: 0.5rem; /* rounded-lg */
            font-size: 1.125rem; /* text-xl */
            font-weight: 700; /* font-bold */
            color: #065f46; /* green-700 */
            z-index: 10;
        }
    </style>
</head>
<body class="p-4">

    <!-- 메인 컨테이너 -->
    <div id="app-container" class="w-full max-w-lg bg-white shadow-xl rounded-xl p-6 md:p-8">
        <h1 class="text-3xl font-extrabold text-center text-indigo-700 mb-6">정산 링크 생성 및 공유</h1>

        <!-- 1. 입력 폼 (URL 파라미터가 없을 때 표시) -->
        <div id="input-form-section">
            <div class="space-y-4">
                <p class="text-sm text-gray-500 mb-6 text-center">
                    정산 정보를 입력하고 링크를 생성하세요. 이 링크를 QR 코드로 만들어 공유할 수 있습니다.
                </p>

                <!-- 1.1. 금액 계산/입력 -->
                <div id="amount-input-group" class="p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                    <label for="totalAmount" class="block text-lg font-semibold text-indigo-700 mb-1">총 금액 / 인당 금액 설정</label>
                    <div id="calc-input-group" class="flex items-center space-x-2 mb-2">
                        <!-- 레이아웃 문제 해결을 위해 flex-1 대신 w-5/12 사용 -->
                        <input type="number" id="totalAmount" placeholder="총 결제 금액 (선택)" class="w-5/12 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <span class="text-gray-500">÷</span>
                        <!-- 레이아웃 문제 해결을 위해 flex-1 대신 w-5/12 사용 -->
                        <input type="number" id="numPeople" placeholder="인원수 (선택)" class="w-5/12 p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                        <button id="calculateBtn" class="bg-indigo-500 text-white p-3 rounded-lg hover:bg-indigo-600 transition duration-150 whitespace-nowrap">계산</button>
                    </div>
                    <p id="calc-result" class="text-sm text-gray-600 h-5"></p>
                    
                    <label for="amountPerPerson" class="block text-sm font-medium text-gray-700 mt-4 mb-1">
                        ✨ 인당 송금액 (필수)
                    </label>
                    <input type="number" id="amountPerPerson" required placeholder="예: 15000" class="w-full p-3 border-2 border-indigo-400 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 font-bold text-xl">
                </div>

                <!-- 1.2. 계좌 정보 -->
                <div>
                    <label for="bankName" class="block text-sm font-medium text-gray-700 mb-1">은행명 (필수)</label>
                    <input type="text" id="bankName" required placeholder="예: 카카오뱅크, 국민은행" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div>
                    <label for="accountNumber" class="block text-sm font-medium text-gray-700 mb-1">계좌번호 (필수)</label>
                    <input type="text" id="accountNumber" required placeholder="숫자만 입력해 주세요" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div>
                    <label for="accountHolder" class="block text-sm font-medium text-gray-700 mb-1">예금주 (필수)</label>
                    <input type="text" id="accountHolder" required placeholder="예: 홍길동" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <button id="generateBtn" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition duration-150 shadow-md">
                    정산 링크 생성하기
                </button>
            </div>
            
            <!-- 생성된 링크 표시 영역 -->
            <div id="link-output-area" class="mt-8 p-4 bg-gray-100 rounded-lg hidden">
                <p class="font-semibold text-gray-700 mb-2">✅ 공유할 정산 링크가 생성되었습니다:</p>
                <div class="flex items-center space-x-2">
                    <input type="text" id="generatedLink" readonly class="flex-1 p-3 border border-gray-300 rounded-lg bg-white text-sm truncate">
                    <button id="copyLinkBtn" class="bg-indigo-600 text-white px-4 py-3 rounded-lg hover:bg-indigo-700 transition duration-150 whitespace-nowrap">
                        복사
                    </button>
                </div>

                <!-- QR 코드 출력 영역 추가 -->
                <div class="mt-4 p-4 bg-white rounded-lg shadow-inner flex justify-center flex-col items-center">
                    <p class="font-bold text-gray-700 mb-3">📸 QR 코드로 바로 스캔하세요</p>
                    <div id="qrcode-container" class="p-2 border border-gray-300 rounded-lg bg-white">
                        <!-- QR 코드가 여기에 생성됩니다 -->
                    </div>
                </div>

                <p class="text-xs text-red-500 mt-2">
                    * 이 링크를 QR 코드로 변환하여 사용하거나 메시지로 공유하세요.
                </p>
            </div>
        </div>

        <!-- 2. 결과 표시 (URL 파라미터가 있을 때 표시) -->
        <div id="result-display-section" class="hidden text-center">
            <!-- SVG 아이콘 수정: 깨지는 아이콘 대신 지갑/돈 모양 아이콘으로 교체 -->
            <svg class="mx-auto h-16 w-16 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            <h2 class="text-3xl font-bold text-gray-800 mt-4">정산 요청</h2>
            <p class="text-lg text-gray-600 mt-2 mb-8">아래 계좌로 금액을 송금해 주세요. (터치 시 정보가 복사됩니다!)</p>

            <div class="space-y-4 p-6 bg-green-50 rounded-xl border-4 border-green-300 shadow-lg">
                <div class="text-left">
                    <p class="text-2xl font-bold text-green-700">송금할 금액</p>
                    <p id="displayAmount" class="5xl font-extrabold text-green-900 mt-1">0원</p>
                </div>
                
                <div class="border-t border-green-200 pt-4 space-y-2 text-left">
                    <!-- 은행명 복사 가능하도록 수정 (relative 추가) -->
                    <div id="copyBank" class="flex justify-between items-center bg-white p-3 rounded-lg cursor-pointer hover:bg-gray-50 transition duration-100 relative">
                        <span class="font-medium text-gray-500">은행명</span>
                        <span id="displayBank" class="font-semibold text-gray-800"></span>
                    </div>
                    <!-- 계좌번호 복사 가능하도록 수정 (relative 추가) -->
                    <div id="copyAccount" class="flex justify-between items-center bg-white p-3 rounded-lg cursor-pointer hover:bg-gray-50 transition duration-100 relative">
                        <span class="font-medium text-gray-500">계좌번호</span>
                        <span id="displayAccount" class="font-semibold text-gray-800"></span>
                    </div>
                    <!-- 예금주 복사 가능하도록 수정 (relative 추가) -->
                    <div id="copyHolder" class="flex justify-between items-center bg-white p-3 rounded-lg cursor-pointer hover:bg-gray-50 transition duration-100 relative">
                        <span class="font-medium text-gray-500">예금주</span>
                        <span id="displayHolder" class="font-semibold text-gray-800"></span>
                    </div>
                </div>
            </div>

            <p class="text-sm text-gray-500 mt-6">
                페이지가 다시 필요하면 이 링크를 북마크하거나 저장하세요.
            </p>
            <button onclick="window.location.href = window.location.pathname" class="mt-4 text-indigo-600 hover:text-indigo-800 font-medium">
                새로운 링크 생성하기
            </button>
        </div>
    </div>

    <script>
        // 전역 변수 설정
        const amountInput = document.getElementById('amountPerPerson');
        const bankInput = document.getElementById('bankName');
        const accountInput = document.getElementById('accountNumber');
        const holderInput = document.getElementById('accountHolder');
        const generateBtn = document.getElementById('generateBtn');
        const calculateBtn = document.getElementById('calculateBtn');
        const totalAmountInput = document.getElementById('totalAmount');
        const numPeopleInput = document.getElementById('numPeople');
        const calcResult = document.getElementById('calc-result');

        const inputSection = document.getElementById('input-form-section');
        const resultSection = document.getElementById('result-display-section');
        const generatedLinkInput = document.getElementById('generatedLink');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const qrcodeContainer = document.getElementById('qrcode-container');
        
        // 정산 요청 페이지의 복사 대상 요소
        const copyBankElement = document.getElementById('copyBank');
        const copyAccountElement = document.getElementById('copyAccount');
        const copyHolderElement = document.getElementById('copyHolder');

        // OGP 관련 메타 태그 요소
        const ogUrl = document.getElementById('ogUrl');
        const ogTitle = document.getElementById('ogTitle');
        const ogDescription = document.getElementById('ogDescription');


        /**
         * 숫자를 한국 통화 형식으로 포맷합니다.
         * @param {number} number
         */
        const formatCurrency = (number) => {
            return new Intl.NumberFormat('ko-KR', {
                style: 'currency',
                currency: 'KRW',
                minimumFractionDigits: 0
            }).format(number);
        };

        /**
         * 클립보드에 텍스트를 복사하고 시각적 피드백을 제공합니다.
         * @param {string} textToCopy 복사할 텍스트
         * @param {HTMLElement} element 복사 성공 시 스타일을 적용할 HTML 요소 (복사 대상 div)
         */
        function copyToClipboard(textToCopy, element) {
            // 임시 input 요소를 생성하여 복사 작업을 수행
            const tempInput = document.createElement('input');
            tempInput.value = textToCopy;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            let successful = false;
            try {
                successful = document.execCommand('copy');
            } catch (err) {
                console.error('클립보드 복사 오류:', err);
            }
            
            document.body.removeChild(tempInput);

            if (successful) {
                // 1. 메시지 오버레이 생성
                const messageOverlay = document.createElement('div');
                messageOverlay.textContent = '✅ 복사 완료!';
                messageOverlay.classList.add('copy-message-overlay'); // CSS 클래스 사용

                // 2. 오버레이 추가 및 배경색 변경 (copy-success 클래스 사용)
                element.classList.add('copy-success');
                element.appendChild(messageOverlay);

                // 3. 1초 후 오버레이 제거 및 클래스 복구
                setTimeout(() => {
                    element.classList.remove('copy-success');
                    if (element.contains(messageOverlay)) {
                        element.removeChild(messageOverlay);
                    }
                }, 1000);

            } else {
                console.error('복사 명령 실패.');
            }
        }

        /**
         * 총 금액과 인원수를 기반으로 인당 송금액을 계산합니다.
         */
        calculateBtn.addEventListener('click', () => {
            const total = parseInt(totalAmountInput.value);
            const num = parseInt(numPeopleInput.value);

            if (isNaN(total) || isNaN(num) || num <= 0) {
                // 커스텀 알림 UI를 사용해야 하지만, 여기서는 임시로 콘솔 메시지로 대체
                console.error('총 금액과 인원수를 정확히 입력해 주세요.');
                calcResult.textContent = '총 금액과 인원수를 정확히 입력해 주세요.';
                return;
            }

            const perPerson = Math.ceil(total / num); // 올림 처리하여 계산
            amountInput.value = perPerson;
            calcResult.textContent = `계산 결과: 인당 ${formatCurrency(perPerson)} (${total} ÷ ${num})`;
        });

        /**
         * 입력 필드를 비활성화하고 관련 버튼을 숨깁니다.
         */
        function disableInputFields() {
            // 1. 필수 입력 필드를 읽기 전용으로 설정 및 스타일 변경
            const primaryInputs = [amountInput, bankInput, accountInput, holderInput];
            
            primaryInputs.forEach(input => {
                input.setAttribute('readonly', true);
                // 읽기 전용 상태를 명확히 보여주기 위해 스타일 변경
                input.classList.add('bg-gray-100', 'text-gray-700', 'cursor-default');
                input.classList.remove('focus:ring-indigo-500', 'focus:border-indigo-500', 'border-indigo-400');
            });
            
            // 2. 계산 관련 필드/버튼 숨기기
            const calcInputGroup = document.getElementById('calc-input-group');
            if (calcInputGroup) {
                calcInputGroup.classList.add('hidden');
            }
            calcResult.classList.add('hidden');
            
            // 3. 정산 링크 생성하기 버튼 숨기기
            generateBtn.classList.add('hidden');
        }

        /**
         * 입력된 정보를 URL 파라미터로 인코딩하여 링크를 생성합니다.
         */
        generateBtn.addEventListener('click', () => {
            const amount = amountInput.value.trim();
            const bank = bankInput.value.trim();
            const account = accountInput.value.trim();
            const holder = holderInput.value.trim();

            if (!amount || !bank || !account || !holder) {
                // 커스텀 알림 UI를 사용해야 하지만, 여기서는 임시로 콘솔 메시지로 대체
                console.error('모든 필수 정보를 입력해 주세요.');
                return;
            }

            if (isNaN(parseInt(amount))) {
                // 커스텀 알림 UI를 사용해야 하지만, 여기서는 임시로 콘솔 메시지로 대체
                console.error('송금액은 숫자여야 합니다.');
                return;
            }

            // URL 파라미터에 들어갈 데이터를 정의 (간결한 파라미터 이름 사용)
            const params = new URLSearchParams();
            params.append('a', amount); // Amount
            params.append('b', bank);   // Bank Name
            params.append('c', account);// Account Number
            params.append('d', holder); // Account Holder

            // 현재 URL의 경로 + 쿼리 스트링으로 링크 생성
            const generatedUrl = window.location.origin + window.location.pathname + '?' + params.toString();
            
            generatedLinkInput.value = generatedUrl;
            document.getElementById('link-output-area').classList.remove('hidden');

            // --- OGP 태그 동적 업데이트 (링크 생성 시점에서는 사용자가 페이지에 머물러 있지만, 공유되는 URL에 반영) ---
            updateOGPMeta(amount, bank, holder, generatedUrl);

            // --- QR 코드 생성 로직 ---
            qrcodeContainer.innerHTML = ''; // 기존 QR 코드 삭제

            new QRCode(qrcodeContainer, {
                text: generatedUrl,
                width: 180,
                height: 180,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H // 높은 에러 보정 레벨
            });
            // ------------------------

            // --- 새로 추가된 기능: 입력 필드 비활성화 및 버튼 숨기기 ---
            disableInputFields(); 
        });

        /**
         * OGP 메타 태그의 내용을 동적으로 업데이트합니다.
         * (주의: 공유 플랫폼의 크롤러는 JS 실행 전 정적 HTML을 읽으므로 완벽하게 작동하지 않을 수 있습니다.)
         */
        function updateOGPMeta(amount, bank, holder, url) {
            const formattedAmount = formatCurrency(parseInt(amount));
            
            // Title: [예금주] 님께 [금액] 송금 요청
            ogTitle.setAttribute('content', `${decodeURIComponent(holder)}님께 ${formattedAmount} 송금 요청`);
            
            // Description: [은행명] [계좌번호] 확인
            ogDescription.setAttribute('content', `은행: ${decodeURIComponent(bank)}, 계좌: ${accountInput.value.trim()}. 지금 바로 송금하세요!`);
            
            // URL
            ogUrl.setAttribute('content', url);
        }


        /**
         * 생성된 링크를 클립보드에 복사합니다.
         */
        copyLinkBtn.addEventListener('click', () => {
            // generatedLinkInput의 값 복사
            copyToClipboard(generatedLinkInput.value, generatedLinkInput);

            // 복사 성공 시 버튼 텍스트 변경 피드백 
            copyLinkBtn.textContent = '✅ 복사 완료!';
            copyLinkBtn.classList.add('bg-green-500', 'hover:bg-green-500');
            copyLinkBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            setTimeout(() => {
                copyLinkBtn.textContent = '복사';
                copyLinkBtn.classList.remove('bg-green-500', 'hover:bg-green-500');
                copyLinkBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            }, 1500);
        });

        /**
         * URL 파라미터를 확인하고 데이터를 복원하여 표시합니다.
         */
        function checkAndDisplayData() {
            // 페이지 로드 시 OGP URL을 현재 URL로 설정
            ogUrl.setAttribute('content', window.location.href);

            const urlParams = new URLSearchParams(window.location.search);
            
            // 필수 파라미터 확인: a (amount), b (bank), c (account), d (holder)
            const amount = urlParams.get('a');
            const bank = urlParams.get('b');
            const account = urlParams.get('c');
            const holder = urlParams.get('d');

            // --- OGP 태그 업데이트 (페이지가 파라미터와 함께 로드될 때) ---
            if (amount && bank && holder) {
                 updateOGPMeta(amount, bank, holder, window.location.href);
            }
            
            if (amount && bank && account && holder) {
                // 데이터가 있을 경우: 결과 표시 섹션 활성화
                inputSection.classList.add('hidden');
                resultSection.classList.remove('hidden');
                
                // 복원된 데이터
                const decodedBank = decodeURIComponent(bank);
                const decodedAccount = decodeURIComponent(account);
                const decodedHolder = decodeURIComponent(holder);

                document.getElementById('displayAmount').textContent = formatCurrency(parseInt(amount));
                document.getElementById('displayBank').textContent = decodedBank;
                document.getElementById('displayAccount').textContent = decodedAccount;
                document.getElementById('displayHolder').textContent = decodedHolder;

                // --- 정산 요청 페이지 복사 이벤트 리스너 추가 ---
                
                // 은행명 복사
                copyBankElement.addEventListener('click', () => {
                    copyToClipboard(decodedBank, copyBankElement);
                });
                
                // 계좌번호 복사
                copyAccountElement.addEventListener('click', () => {
                    copyToClipboard(decodedAccount, copyAccountElement);
                });

                // 예금주 복사
                copyHolderElement.addEventListener('click', () => {
                    copyToClipboard(decodedHolder, copyHolderElement);
                });
                // ------------------------------------------

            } else {
                // 데이터가 없을 경우: 입력 폼 섹션 활성화
                inputSection.classList.remove('hidden');
                resultSection.classList.add('hidden');
            }
        }

        // 페이지 로드 시 정산 데이터 복원 로직 실행
        window.onload = checkAndDisplayData;
    </script>
</body>
</html>
